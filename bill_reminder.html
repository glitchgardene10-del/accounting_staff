<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¾…ç¹³å¸³å–®/è«‹æ¬¾ä¸­å¿ƒ</title>
    
    <script>
        (function() {
            const userSession = sessionStorage.getItem('kuangyou_user');
            if (!userSession) {
                alert("â›” è«‹å…ˆç™»å…¥ï¼");
                window.location.href = 'index.html'; 
                return;
            }
        })();
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/dayjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, where, deleteDoc, doc, updateDoc, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyDkC6kfqpmEeMKIvWIqftounTSH_NPp25M",
            authDomain: "assessmentsystem-9e2ec.firebaseapp.com",
            projectId: "assessmentsystem-9e2ec",
            storageBucket: "assessmentsystem-9e2ec.firebasestorage.app",
            messagingSenderId: "455151254122",
            appId: "1:455151254122:web:45787cfce4469bff90e813",
            measurementId: "G-201C6BE86Z"
        };

        const app = initializeApp(firebaseConfig);
        window.db = getFirestore(app);
        window.auth = getAuth(app);
        
        window.collection = collection;
        window.addDoc = addDoc;
        window.onSnapshot = onSnapshot;
        window.query = query;
        window.orderBy = orderBy;
        window.where = where;
        window.deleteDoc = deleteDoc;
        window.doc = doc;
        window.updateDoc = updateDoc;
        window.writeBatch = writeBatch;

        onAuthStateChanged(window.auth, (user) => {
            if (user) window.isAuthReady = true;
        });
    </script>

    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f1f5f9; }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const EXPENSE_TYPES = [
            { name: "æ°´é›»è²»", code: "5202" },
            { name: "é›»è©±/ç¶²è·¯è²»", code: "5203" },
            { name: "å‹å¥ä¿è²» (å…¬å¸è² æ“”)", code: "5105" },
            { name: "å‹å¥ä¿/é€€ä¼‘é‡‘ (ç¹³ç´ç¸½é¡)", code: "2201" }, // ç‰¹æ®Šè™•ç†
            { name: "å» å•†è²¨æ¬¾", code: "5204" },
            { name: "æˆ¿ç§Ÿ", code: "5201" },
            { name: "å…¶ä»–", code: "5299" }
        ];

        const BillApp = () => {
            const [bills, setBills] = useState([]);
            const [loading, setLoading] = useState(false);
            const [currentUser, setCurrentUser] = useState(JSON.parse(sessionStorage.getItem('kuangyou_user') || '{}'));
            
            // æ–°å¢è¡¨å–®
            const [showForm, setShowForm] = useState(false);
            const [title, setTitle] = useState('');
            const [amount, setAmount] = useState('');
            const [dueDate, setDueDate] = useState(dayjs().format('YYYY-MM-DD'));
            const [type, setType] = useState('5202'); // é è¨­æ°´é›»
            const [note, setNote] = useState('');

            useEffect(() => {
                // è®€å–æœªä»˜æ¬¾æˆ–æœ€è¿‘ä»˜æ¬¾çš„å¸³å–®
                const q = window.query(
                    window.collection(window.db, "bill_requests"),
                    window.orderBy("dueDate", "asc") // è¶Šå¿«åˆ°æœŸçš„è¶Šä¸Šé¢
                );

                const unsubscribe = window.onSnapshot(q, (snapshot) => {
                    const list = [];
                    snapshot.forEach(doc => list.push({ id: doc.id, ...doc.data() }));
                    // ç°¡å–®éæ¿¾ï¼šåªé¡¯ç¤ºã€Œæœªä»˜æ¬¾ã€æˆ–æ˜¯ã€Œæœ€è¿‘7å¤©å…§ä»˜éã€çš„
                    const showList = list.filter(b => b.status === 'pending' || dayjs(b.paidAt).isAfter(dayjs().subtract(7, 'day')));
                    setBills(showList);
                });

                return () => unsubscribe();
            }, []);

            const handleSubmit = async () => {
                if (!title || !amount) return alert("è«‹å¡«å¯«å®Œæ•´");
                setLoading(true);
                try {
                    await window.addDoc(window.collection(window.db, "bill_requests"), {
                        title,
                        amount: Number(amount),
                        dueDate,
                        typeCode: type,
                        typeName: EXPENSE_TYPES.find(t=>t.code===type)?.name,
                        note,
                        requester: currentUser.name,
                        status: 'pending',
                        createdAt: new Date().toISOString()
                    });
                    alert("âœ… å·²é€å‡ºçµ¦è€é—†ï¼");
                    setShowForm(false);
                    setTitle(''); setAmount(''); setNote('');
                } catch(e) { alert("å¤±æ•—: " + e.message); }
                setLoading(false);
            };

            const handlePay = async (bill) => {
                if(!confirm(`ç¢ºèªå·²æ”¯ä»˜é€™ç­†æ¬¾é …ï¼Ÿ\n\nã€${bill.title}ã€‘ $${new Intl.NumberFormat().format(bill.amount)}\n\n(ç³»çµ±å°‡è‡ªå‹•ç”¢ç”Ÿä¸€ç­†ã€ŒéŠ€è¡Œè½‰å¸³ã€çš„æœƒè¨ˆå‚³ç¥¨)`)) return;
                
                setLoading(true);
                try {
                    const batch = window.writeBatch(window.db);
                    
                    // 1. æ›´æ–°å¸³å–®ç‹€æ…‹
                    const billRef = window.doc(window.db, "bill_requests", bill.id);
                    batch.update(billRef, {
                        status: 'paid',
                        paidAt: new Date().toISOString(),
                        payer: currentUser.name
                    });

                    // 2. è‡ªå‹•ç”¢ç”Ÿæœƒè¨ˆå‚³ç¥¨ (è€é—†æœ€æ„›çš„åŠŸèƒ½)
                    const journalRef = window.doc(window.collection(window.db, "accounting_journal"));
                    
                    // åˆ¤æ–·å€Ÿæ–¹ç§‘ç›®
                    let debitEntry;
                    if (bill.typeCode === '2201') {
                        // ç‰¹æ®Šé‚è¼¯ï¼šå¦‚æœæ˜¯ç¹³å‹å¥ä¿ï¼Œé€šå¸¸æ˜¯æ²–éŠ·ä»£æ‰£æ¬¾ (é€™è£¡ç°¡åŒ–è™•ç†ï¼Œå…ˆå…¨å€Ÿä»£æ‰£æ¬¾ï¼Œä¹‹å¾Œæ‚¨å¯ä»¥æ‰‹å‹•èª¿æ•´)
                        debitEntry = { type: 'debit', code: '2201', name: 'ä»£æ‰£æ¬¾/æ‡‰ä»˜è²»ç”¨', amount: bill.amount };
                    } else {
                        debitEntry = { type: 'debit', code: bill.typeCode, name: bill.typeName, amount: bill.amount };
                    }

                    batch.set(journalRef, {
                        date: dayjs().format('YYYY-MM-DD'),
                        description: `æ”¯ä»˜å¸³å–®: ${bill.title}`,
                        source: 'BILL_PAYMENT',
                        entries: [
                            debitEntry,
                            { type: 'credit', code: '1102', name: 'éŠ€è¡Œå­˜æ¬¾', amount: bill.amount }
                        ],
                        totalAmount: bill.amount,
                        createdAt: new Date().toISOString()
                    });

                    await batch.commit();
                    alert("âœ… ä»˜æ¬¾å®Œæˆï¼å‚³ç¥¨å·²è‡ªå‹•å»ºç«‹ã€‚");

                } catch(e) { console.error(e); alert("è™•ç†å¤±æ•—"); }
                setLoading(false);
            };

            const handleDelete = async (id) => {
                if(confirm("åˆªé™¤æ­¤è«‹æ±‚ï¼Ÿ")) await window.deleteDoc(window.doc(window.db, "bill_requests", id));
            };

            // è¨ˆç®—å¾…ç¹³ç¸½é¡
            const totalPending = bills.filter(b => b.status === 'pending').reduce((s, b) => s + b.amount, 0);

            return (
                <div className="max-w-md mx-auto min-h-screen flex flex-col bg-slate-100 shadow-2xl">
                    <div className="bg-slate-800 text-white p-6 rounded-b-3xl shadow-lg sticky top-0 z-10">
                        <div className="flex justify-between items-start mb-4">
                            <div>
                                <h1 className="text-2xl font-black tracking-wider">å¾…ç¹³å¸³å–®</h1>
                                <p className="text-xs text-slate-400">Bill Payment Center</p>
                            </div>
                            <a href="index.html" className="text-xs bg-slate-700 px-3 py-1 rounded-full hover:bg-slate-600">å›é¦–é </a>
                        </div>
                        
                        <div className="bg-slate-700/50 p-4 rounded-xl flex justify-between items-center border border-slate-600">
                            <span className="text-sm font-bold text-slate-300">å¾…ä»˜ç¸½é¡</span>
                            <span className="text-3xl font-black text-yellow-400">${new Intl.NumberFormat().format(totalPending)}</span>
                        </div>
                    </div>

                    <div className="p-4 flex-1 overflow-y-auto pb-24 space-y-4">
                        {bills.length === 0 && <div className="text-center text-slate-400 py-10">ç›®å‰æ²’æœ‰å¸³å–®ï¼Œå¤ªæ£’äº†ï¼ğŸ‰</div>}
                        
                        {bills.map(bill => {
                            const isExpired = bill.status === 'pending' && dayjs().isAfter(dayjs(bill.dueDate));
                            const isUrgent = bill.status === 'pending' && dayjs(bill.dueDate).diff(dayjs(), 'day') <= 3;
                            
                            return (
                                <div key={bill.id} className={`bg-white rounded-xl p-4 shadow-sm border-l-4 relative ${bill.status === 'paid' ? 'border-l-green-500 opacity-60' : (isExpired ? 'border-l-red-600 bg-red-50' : (isUrgent ? 'border-l-orange-400' : 'border-l-blue-500'))}`}>
                                    
                                    <div className="flex justify-between items-start mb-2">
                                        <div>
                                            <div className="font-bold text-lg text-slate-800">{bill.title}</div>
                                            <div className="text-xs text-slate-500 flex gap-2 mt-1">
                                                <span className="bg-slate-100 px-2 py-0.5 rounded">{bill.typeName}</span>
                                                <span>æœŸé™: {bill.dueDate}</span>
                                            </div>
                                        </div>
                                        <div className="text-right">
                                            <div className="text-xl font-black font-mono text-slate-700">${new Intl.NumberFormat().format(bill.amount)}</div>
                                            <div className="text-[10px] text-slate-400">{bill.requester} æå ±</div>
                                        </div>
                                    </div>

                                    {bill.note && <div className="text-sm text-slate-600 bg-slate-50 p-2 rounded mb-3">{bill.note}</div>}

                                    {bill.status === 'pending' ? (
                                        <div className="flex gap-2 mt-2">
                                            <button onClick={()=>handlePay(bill)} className="flex-1 bg-slate-900 text-white py-2 rounded-lg font-bold shadow hover:bg-black active:scale-95 transition flex items-center justify-center gap-2">
                                                <span>ğŸ’³</span> æˆ‘å·²åŒ¯æ¬¾ (Pay)
                                            </button>
                                            <button onClick={()=>handleDelete(bill.id)} className="px-3 text-slate-300 hover:text-red-500">ğŸ—‘ï¸</button>
                                        </div>
                                    ) : (
                                        <div className="text-center text-xs font-bold text-green-600 border-t pt-2 mt-2">
                                            âœ… å·²ä»˜æ¬¾ ({dayjs(bill.paidAt).format('MM/DD')})
                                        </div>
                                    )}
                                    
                                    {isExpired && bill.status === 'pending' && (
                                        <div className="absolute top-2 right-2 text-[10px] font-bold bg-red-600 text-white px-2 py-0.5 rounded-full animate-pulse">
                                            å·²éæœŸ
                                        </div>
                                    )}
                                </div>
                            );
                        })}
                    </div>

                    {/* Floating Add Button (Admin Only - but open to all for now) */}
                    <button onClick={()=>setShowForm(true)} className="fixed bottom-6 right-6 bg-blue-600 text-white w-14 h-14 rounded-full shadow-2xl flex items-center justify-center text-2xl font-bold hover:bg-blue-700 hover:scale-110 transition z-50">
                        ï¼‹
                    </button>

                    {/* Add Form Modal */}
                    {showForm && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-end sm:items-center justify-center p-4 backdrop-blur-sm">
                            <div className="bg-white w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden animate-slide-up">
                                <div className="bg-slate-800 p-4 text-white font-bold flex justify-between">
                                    <span>æ–°å¢è«‹æ¬¾å–®</span>
                                    <button onClick={()=>setShowForm(false)}>âœ•</button>
                                </div>
                                <div className="p-6 space-y-4">
                                    <div>
                                        <label className="block text-xs font-bold text-slate-500 mb-1">å¸³å–®åç¨±</label>
                                        <input type="text" className="w-full border-2 rounded-lg p-2" placeholder="ä¾‹å¦‚: 12æœˆé›»è²»" value={title} onChange={e=>setTitle(e.target.value)} />
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-xs font-bold text-slate-500 mb-1">é‡‘é¡</label>
                                            <input type="number" className="w-full border-2 rounded-lg p-2 font-mono" placeholder="$" value={amount} onChange={e=>setAmount(e.target.value)} />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-slate-500 mb-1">ç¹³è²»æœŸé™</label>
                                            <input type="date" className="w-full border-2 rounded-lg p-2" value={dueDate} onChange={e=>setDueDate(e.target.value)} />
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-slate-500 mb-1">è²»ç”¨åˆ†é¡ (ç”¨æ–¼è‡ªå‹•åšå¸³)</label>
                                        <select className="w-full border-2 rounded-lg p-2 bg-white" value={type} onChange={e=>setType(e.target.value)}>
                                            {EXPENSE_TYPES.map(t => <option key={t.code} value={t.code}>{t.name}</option>)}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-slate-500 mb-1">å‚™è¨» (åŒ¯æ¬¾å¸³è™Ÿç­‰)</label>
                                        <textarea className="w-full border-2 rounded-lg p-2 h-20 text-sm" placeholder="éŠ€è¡Œä»£ç¢¼: xxx å¸³è™Ÿ: xxx" value={note} onChange={e=>setNote(e.target.value)}></textarea>
                                    </div>
                                    <button onClick={handleSubmit} className="w-full bg-blue-600 text-white font-bold py-3 rounded-lg shadow hover:bg-blue-700">
                                        é€å‡ºæé†’
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<BillApp />);
    </script>
    <style>
        @keyframes slide-up { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .animate-slide-up { animation: slide-up 0.3s ease-out; }
    </style>
</body>

</html>
