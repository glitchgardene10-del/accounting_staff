<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è¡Œæ”¿é›¶ç”¨é‡‘ç®¡ç† (å„²å€¼ç‰ˆ)</title>
    
    <script>
        (function() {
            const userSession = sessionStorage.getItem('kuangyou_user');
            if (!userSession) {
                alert("â›” è«‹å…ˆç™»å…¥ï¼");
                window.location.href = 'index.html'; 
                return;
            }
        })();
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/dayjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, where, deleteDoc, doc, updateDoc, increment, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyDkC6kfqpmEeMKIvWIqftounTSH_NPp25M",
            authDomain: "assessmentsystem-9e2ec.firebaseapp.com",
            projectId: "assessmentsystem-9e2ec",
            storageBucket: "assessmentsystem-9e2ec.firebasestorage.app",
            messagingSenderId: "455151254122",
            appId: "1:455151254122:web:45787cfce4469bff90e813",
            measurementId: "G-201C6BE86Z"
        };

        const app = initializeApp(firebaseConfig);
        window.db = getFirestore(app);
        window.auth = getAuth(app);
        
        // ç¶å®š Firebase å‡½æ•¸
        window.collection = collection;
        window.addDoc = addDoc;
        window.onSnapshot = onSnapshot;
        window.query = query;
        window.orderBy = orderBy;
        window.where = where;
        window.deleteDoc = deleteDoc;
        window.doc = doc;
        window.updateDoc = updateDoc;
        window.increment = increment;
        window.setDoc = setDoc;

        onAuthStateChanged(window.auth, (user) => {
            if (user) window.isAuthReady = true;
        });
    </script>

    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .toggle-checkbox:checked { right: 0; border-color: #10b981; }
        .toggle-checkbox:checked + .toggle-label { background-color: #10b981; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const CATEGORIES = ["è†³é£Ÿè²»", "æ–‡å…·ç”¨å“", "éƒµé›»è²»", "äº¤é€š/æ²¹è³‡", "ä¿®ç¹•è²»", "é›œé …æ”¯å‡º", "äº¤éš›è²»", "å…¶ä»–"];
        const PAYERS = [
            { id: 'petty_cash', name: 'ğŸ“¦ å…¬å¸é›¶ç”¨é‡‘ (æ‰£é¤˜é¡)' },
            { id: 'boss_paid', name: 'ğŸ‘‘ è€é—†ä»£å¢Š (ä¸æ‰£é¤˜é¡)' },
            { id: 'bank', name: 'ğŸ’³ éŠ€è¡Œè½‰å¸³ (ä¸æ‰£é¤˜é¡)' }
        ];

        const ExpenseLogApp = () => {
            const [entries, setEntries] = useState([]);
            const [loading, setLoading] = useState(false);
            const [filterMonth, setFilterMonth] = useState(dayjs().format('YYYY-MM'));
            const [currentUser, setCurrentUser] = useState(JSON.parse(sessionStorage.getItem('kuangyou_user') || '{}'));
            
            // â˜… æ–°å¢ï¼šé›¶ç”¨é‡‘é¤˜é¡
            const [cashBalance, setCashBalance] = useState(0);

            // è¡¨å–®ç‹€æ…‹
            const [mode, setMode] = useState('expense'); // 'expense' (æ”¯å‡º) æˆ– 'income' (å…¥é‡‘)
            const [date, setDate] = useState(dayjs().format('YYYY-MM-DD'));
            const [item, setItem] = useState('');
            const [amount, setAmount] = useState('');
            const [category, setCategory] = useState('è†³é£Ÿè²»');
            const [payer, setPayer] = useState('petty_cash');
            const [note, setNote] = useState('');

            useEffect(() => {
                // 1. ç›£è½ç•¶æœˆæµæ°´å¸³
                const startStr = `${filterMonth}-01`;
                const endStr = dayjs(filterMonth).endOf('month').format('YYYY-MM-DD');
                
                const q = window.query(
                    window.collection(window.db, "accounting_expenses"),
                    window.where("date", ">=", startStr),
                    window.where("date", "<=", endStr),
                    window.orderBy("date", "desc")
                );

                const unsub1 = window.onSnapshot(q, (snapshot) => {
                    const list = [];
                    snapshot.forEach(doc => list.push({ id: doc.id, ...doc.data() }));
                    setEntries(list);
                });

                // 2. ç›£è½é›¶ç”¨é‡‘ç¸½é¤˜é¡ (å¾ç³»çµ±è¨­å®šæª”è®€å–)
                const unsub2 = window.onSnapshot(window.doc(window.db, "system_settings", "petty_cash"), (doc) => {
                    if (doc.exists()) {
                        setCashBalance(doc.data().balance || 0);
                    } else {
                        // å¦‚æœé‚„æ²’æœ‰è¨­å®šæª”ï¼Œåˆå§‹åŒ–ç‚º 0
                        window.setDoc(window.doc(window.db, "system_settings", "petty_cash"), { balance: 0 });
                    }
                });

                return () => { unsub1(); unsub2(); };
            }, [filterMonth]);

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!item || !amount) return alert("è«‹å¡«å¯«é …ç›®èˆ‡é‡‘é¡");
                if (!window.isAuthReady && !window.auth.currentUser) return alert("âš ï¸ è³‡æ–™åº«é€£ç·šä¸­ï¼Œè«‹ç¨å¾Œ...");

                setLoading(true);
                const val = Number(amount);

                try {
                    // A. å¯«å…¥æµæ°´å¸³ç´€éŒ„
                    await window.addDoc(window.collection(window.db, "accounting_expenses"), {
                        date,
                        type: mode, // 'expense' or 'income'
                        item: mode === 'income' ? `[å…¥é‡‘] ${item}` : item,
                        amount: val,
                        category: mode === 'income' ? 'é›¶ç”¨é‡‘è£œçµ¦' : category,
                        payer: mode === 'income' ? 'boss_deposit' : payer, // å…¥é‡‘ä¾†æº
                        note,
                        recorder: currentUser.name || 'Admin',
                        status: 'pending',
                        createdAt: new Date().toISOString()
                    });

                    // B. å³æ™‚æ›´æ–°é›¶ç”¨é‡‘é¤˜é¡ (å¦‚æœæ˜¯ ç”¨é›¶ç”¨é‡‘æ”¯å‡º æˆ– è£œå…¥é›¶ç”¨é‡‘)
                    // åªæœ‰ç•¶ä»˜æ¬¾æ–¹å¼æ˜¯ 'petty_cash' (æ”¯å‡º) æˆ–æ˜¯ 'income' (å…¥é‡‘) æ™‚æ‰å‹•é¤˜é¡
                    // å¦‚æœæ˜¯ 'boss_paid' (è€é—†ä»£å¢Š)ï¼Œå‰‡ä¸å‹•é¤˜é¡
                    if (mode === 'income') {
                        await window.updateDoc(window.doc(window.db, "system_settings", "petty_cash"), {
                            balance: window.increment(val)
                        });
                    } else if (mode === 'expense' && payer === 'petty_cash') {
                        await window.updateDoc(window.doc(window.db, "system_settings", "petty_cash"), {
                            balance: window.increment(-val)
                        });
                    }
                    
                    // æ¸…ç©ºèˆ‡æç¤º
                    setItem('');
                    setAmount('');
                    setNote('');
                    
                } catch (err) {
                    console.error(err);
                    alert("å„²å­˜å¤±æ•—ï¼š" + err.message);
                }
                setLoading(false);
            };

            const handleDelete = async (ent) => {
                if(!confirm(`ç¢ºå®šåˆªé™¤æ­¤ç­† ${ent.type === 'income' ? 'å…¥é‡‘' : 'æ”¯å‡º'} ç´€éŒ„ï¼Ÿ\n\næ³¨æ„ï¼šé€™å°‡æœƒã€Œå›æ»¾ã€é¤˜é¡è®Šå‹•ï¼`)) return;
                
                try {
                    // 1. åˆªé™¤ç´€éŒ„
                    await window.deleteDoc(window.doc(window.db, "accounting_expenses", ent.id));

                    // 2. å›æ»¾é¤˜é¡ (åå‘æ“ä½œ)
                    const val = Number(ent.amount);
                    if (ent.type === 'income') {
                        // åˆªé™¤å…¥é‡‘ -> é¤˜é¡æ‰£å›ä¾†
                        await window.updateDoc(window.doc(window.db, "system_settings", "petty_cash"), {
                            balance: window.increment(-val)
                        });
                    } else if (ent.type === 'expense' && ent.payer === 'petty_cash') {
                        // åˆªé™¤æ”¯å‡º -> é¤˜é¡åŠ å›ä¾†
                        await window.updateDoc(window.doc(window.db, "system_settings", "petty_cash"), {
                            balance: window.increment(val)
                        });
                    }
                } catch(e) { alert("åˆªé™¤å¤±æ•—"); }
            };

            const totalExpense = useMemo(() => entries.filter(e=>e.type==='expense').reduce((sum, e) => sum + Number(e.amount), 0), [entries]);

            return (
                <div className="max-w-md mx-auto min-h-screen flex flex-col bg-slate-50 shadow-2xl relative">
                    
                    {/* Header with Balance */}
                    <div className="bg-slate-900 text-white p-5 sticky top-0 z-20 shadow-lg rounded-b-3xl">
                        <div className="flex justify-between items-start mb-4">
                            <div>
                                <div className="text-xs text-slate-400 font-bold tracking-wider mb-1">CASH BOX BALANCE</div>
                                <div className={`text-4xl font-black font-mono ${cashBalance < 0 ? 'text-red-400' : 'text-emerald-400'}`}>
                                    ${new Intl.NumberFormat().format(cashBalance)}
                                </div>
                                <div className="text-[10px] text-slate-500 mt-1">ç›®å‰é›¶ç”¨é‡‘é¤˜é¡ (å¯¦é«”ç¾é‡‘)</div>
                            </div>
                            <a href="index.html" className="text-xs border border-slate-600 px-3 py-1 rounded-full hover:bg-slate-700 transition">é€€å‡º</a>
                        </div>
                        
                        <div className="flex bg-slate-800 p-1 rounded-xl">
                            <button onClick={()=>setMode('expense')} className={`flex-1 py-2 rounded-lg text-sm font-bold transition flex items-center justify-center gap-2 ${mode==='expense' ? 'bg-red-500 text-white shadow-lg' : 'text-slate-400 hover:text-white'}`}>
                                <span>ğŸ’¸</span> æ”¯å‡º (èŠ±éŒ¢)
                            </button>
                            <button onClick={()=>setMode('income')} className={`flex-1 py-2 rounded-lg text-sm font-bold transition flex items-center justify-center gap-2 ${mode==='income' ? 'bg-emerald-500 text-white shadow-lg' : 'text-slate-400 hover:text-white'}`}>
                                <span>ğŸ’°</span> è£œå…¥ (å„²å€¼)
                            </button>
                        </div>
                    </div>

                    {/* Input Form */}
                    <div className="p-4 bg-white m-4 rounded-2xl shadow-sm border border-slate-100">
                        <form onSubmit={handleSubmit} className="space-y-3">
                            <div className="grid grid-cols-3 gap-2">
                                <div className="col-span-1">
                                    <label className="text-xs font-bold text-slate-400 block mb-1">æ—¥æœŸ</label>
                                    <input type="date" required value={date} onChange={e=>setDate(e.target.value)} className="w-full p-2 rounded-lg border border-slate-200 text-sm font-bold bg-slate-50" />
                                </div>
                                <div className="col-span-2">
                                    <label className="text-xs font-bold text-slate-400 block mb-1">{mode==='income'?'ä¾†æºèªªæ˜':'æ¶ˆè²»é …ç›®'}</label>
                                    <input type="text" required placeholder={mode==='income'?'ä¾‹å¦‚: è€é—†æ’¥è£œ':'ä¾‹å¦‚: è²·ä¾¿ç•¶'} value={item} onChange={e=>setItem(e.target.value)} className="w-full p-2 rounded-lg border border-slate-200 text-sm" />
                                </div>
                            </div>

                            <div className="grid grid-cols-2 gap-2">
                                {mode === 'expense' && (
                                    <div>
                                        <label className="text-xs font-bold text-slate-400 block mb-1">åˆ†é¡</label>
                                        <select value={category} onChange={e=>setCategory(e.target.value)} className="w-full p-2 rounded-lg border border-slate-200 text-sm bg-white">
                                            {CATEGORIES.map(c => <option key={c} value={c}>{c}</option>)}
                                        </select>
                                    </div>
                                )}
                                <div className={mode==='income' ? 'col-span-2' : ''}>
                                    <label className="text-xs font-bold text-slate-400 block mb-1">é‡‘é¡</label>
                                    <input type="number" required placeholder="$" value={amount} onChange={e=>setAmount(e.target.value)} className={`w-full p-2 rounded-lg border text-sm font-mono font-bold text-right text-lg ${mode==='income'?'border-emerald-200 text-emerald-600':'border-red-200 text-red-600'}`} />
                                </div>
                            </div>

                            {mode === 'expense' && (
                                <div>
                                    <label className="text-xs font-bold text-slate-400 block mb-1">å¾å“ªè£¡æ‰£æ¬¾?</label>
                                    <select value={payer} onChange={e=>setPayer(e.target.value)} className={`w-full p-2 rounded-lg border-2 text-sm font-bold ${payer==='petty_cash' ? 'border-emerald-400 bg-emerald-50 text-emerald-800' : 'border-slate-200 bg-white text-slate-600'}`}>
                                        {PAYERS.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
                                    </select>
                                    {payer !== 'petty_cash' && <div className="text-[10px] text-orange-500 mt-1">* æ­¤é¸é …ä¸æœƒæ‰£é™¤ä¸Šæ–¹é›¶ç”¨é‡‘é¤˜é¡</div>}
                                </div>
                            )}

                            <button type="submit" disabled={loading} className={`w-full text-white font-bold py-3 rounded-xl shadow-lg transition transform active:scale-95 flex justify-center items-center gap-2 ${mode==='income'?'bg-emerald-600 hover:bg-emerald-700':'bg-red-500 hover:bg-red-600'}`}>
                                {loading ? 'è™•ç†ä¸­...' : (mode==='income' ? 'ğŸ“¥ ç¢ºèªå…¥é‡‘ (å¢åŠ é¤˜é¡)' : 'ğŸ“¤ ç¢ºèªæ”¯å‡º (æ‰£é™¤é¤˜é¡)')}
                            </button>
                        </form>
                    </div>

                    {/* Recent List */}
                    <div className="flex-1 overflow-y-auto px-4 pb-safe-area-bottom">
                        <div className="flex justify-between items-center mb-2 px-2">
                            <h3 className="text-xs font-bold text-slate-400">æœ¬æœˆç´€éŒ„ ({dayjs(filterMonth).format('YYYY/MM')})</h3>
                            <input type="month" value={filterMonth} onChange={e=>setFilterMonth(e.target.value)} className="bg-transparent text-xs border border-slate-200 rounded p-1" />
                        </div>
                        
                        <div className="space-y-3 pb-20">
                            {entries.length === 0 ? (
                                <div className="text-center text-slate-300 py-10 text-sm">æœ¬æœˆå°šç„¡ç´€éŒ„</div>
                            ) : (
                                entries.map(ent => (
                                    <div key={ent.id} className={`p-3 rounded-xl border shadow-sm flex justify-between items-center relative ${ent.type==='income' ? 'bg-emerald-50 border-emerald-100' : 'bg-white border-slate-100'}`}>
                                        <div className="flex-1">
                                            <div className="flex items-center gap-2">
                                                <span className={`text-[10px] font-bold px-2 py-0.5 rounded ${ent.type==='income'?'bg-emerald-200 text-emerald-800':'bg-slate-200 text-slate-600'}`}>
                                                    {dayjs(ent.date).format('MM/DD')}
                                                </span>
                                                <span className="font-bold text-slate-800">{ent.item}</span>
                                            </div>
                                            <div className="text-xs text-slate-400 mt-1 flex gap-2">
                                                <span>{ent.type==='income' ? 'å…¥é‡‘' : ent.category}</span>
                                                <span>â€¢</span>
                                                <span>{ent.recorder}</span>
                                                {ent.payer !== 'petty_cash' && ent.type === 'expense' && <span className="text-orange-500 font-bold">â€¢ {PAYERS.find(p=>p.id===ent.payer)?.name.split(' ')[0]}</span>}
                                            </div>
                                        </div>
                                        <div className="text-right">
                                            <div className={`font-bold text-lg font-mono ${ent.type==='income'?'text-emerald-600':'text-slate-700'}`}>
                                                {ent.type==='income' ? '+' : '-'}${new Intl.NumberFormat().format(ent.amount)}
                                            </div>
                                            {ent.status === 'locked' ? (
                                                <div className="text-[10px] text-slate-400">ğŸ”’ å·²çµå¸³</div>
                                            ) : (
                                                <button onClick={() => handleDelete(ent)} className="text-[10px] text-red-300 hover:text-red-500 underline">åˆªé™¤</button>
                                            )}
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ExpenseLogApp />);
    </script>
</body>

</html>
