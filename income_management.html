<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‡‰æ”¶å¸³æ¬¾ç®¡ç† (éŠ€è¡Œç§‘ç›®æ“´å……ç‰ˆ)</title>
    
    <script>
        window.onerror = function(msg, url, line) {
            if (msg.includes("ResizeObserver")) return;
            alert("âŒ ç¨‹å¼ç™¼ç”ŸéŒ¯èª¤ï¼š\n" + msg + "\nè¡Œæ•¸ï¼š" + line);
            return false;
        };
        (function() {
            try {
                const userSession = sessionStorage.getItem('kuangyou_user');
                if (!userSession) {
                    alert("â›” è«‹å…ˆç™»å…¥ï¼");
                    window.location.href = 'index.html'; 
                    return;
                }
            } catch(e) {}
        })();
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/dayjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, getDoc, setDoc, doc, updateDoc, writeBatch, increment, query, where, orderBy, addDoc, deleteDoc, deleteField } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDkC6kfqpmEeMKIvWIqftounTSH_NPp25M",
            authDomain: "assessmentsystem-9e2ec.firebaseapp.com",
            projectId: "assessmentsystem-9e2ec",
            storageBucket: "assessmentsystem-9e2ec.firebasestorage.app",
            messagingSenderId: "455151254122",
            appId: "1:455151254122:web:45787cfce4469bff90e813",
            measurementId: "G-201C6BE86Z"
        };

        const app = initializeApp(firebaseConfig);
        window.db = getFirestore(app);
        window.auth = getAuth(app);
        
        window.collection = collection;
        window.doc = doc;
        window.getDoc = getDoc;
        window.getDocs = getDocs;
        window.setDoc = setDoc;
        window.addDoc = addDoc;
        window.updateDoc = updateDoc;
        window.writeBatch = writeBatch;
        window.deleteDoc = deleteDoc;
        window.deleteField = deleteField; 
        window.increment = increment;
        window.query = query;
        window.where = where;
        window.orderBy = orderBy;

        onAuthStateChanged(window.auth, (user) => {
            if (user) window.isAuthReady = true;
        });
    </script>

    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f1f5f9; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        const SAFETY_PASSWORD = "8888"; 

        const maskName = (name) => {
            if (!name) return "";
            const len = name.length;
            if (len === 2) return name[0] + "â—‹"; 
            if (len === 3) return name[0] + "â—‹" + name[2]; 
            if (len >= 4) return name[0] + "â—‹â—‹" + name.substring(3); 
            return name;
        };

        const IncomeApp = () => {
            const [activeTab, setActiveTab] = useState('user_pay');
            const [currentMonth, setCurrentMonth] = useState(dayjs().format('YYYY-MM'));
            const [receivables, setReceivables] = useState([]);
            const [caregivers, setCaregivers] = useState([]);
            const [caregiverMap, setCaregiverMap] = useState({}); 
            const [loading, setLoading] = useState(false);
            const [currentUser, setCurrentUser] = useState(JSON.parse(sessionStorage.getItem('kuangyou_user') || '{}'));
            
            // æ¬Šé™ç®¡ç†
            const [isManager, setIsManager] = useState(false);
            const [userEmail, setUserEmail] = useState('');
            const BOSS_EMAILS = ["admin@kuangyou.internal"]; 

            // æœƒè¨ˆç§‘ç›® (éŠ€è¡Œé¸é …)
            const [bankOptions, setBankOptions] = useState([]);

            // ç¯©é¸èˆ‡ç‹€æ…‹
            const [filterCollectionType, setFilterCollectionType] = useState('all'); 
            const [printCaregiver, setPrintCaregiver] = useState('all');
            const [showGovModal, setShowGovModal] = useState(false);
            const [govForm, setGovForm] = useState({ b: '', g: '', s: '' });
            const [showPasteModal, setShowPasteModal] = useState(false);
            const [pasteContent, setPasteContent] = useState('');

            // ç¢ºèªè¦–çª—ç‹€æ…‹
            const [confirmModal, setConfirmModal] = useState({ show: false, type: '', data: null });
            const [confirmAmount, setConfirmAmount] = useState('');
            const [selectedBankCode, setSelectedBankCode] = useState('');

            useEffect(() => { 
                const unsubscribe = window.auth.onAuthStateChanged((user) => {
                    if (user) {
                        setUserEmail(user.email);
                        if (BOSS_EMAILS.includes(user.email)) setIsManager(true);
                        else setIsManager(false);
                    }
                });
                
                fetchCaregivers(); 
                fetchCaregiverMap(); 
                fetchBankSubjects(); 
                return () => unsubscribe();
            }, []);

            useEffect(() => { fetchData(); }, [currentMonth, activeTab]);

            // â˜…â˜…â˜… ä¿®æ­£ï¼šæŠ“å–ç¯„åœæ“´å¤§è‡³ 1101 ~ 1105 (ç¾é‡‘ã€éŠ€è¡Œå­˜æ¬¾ã€å®šæœŸå­˜æ¬¾ç­‰) â˜…â˜…â˜…
            const fetchBankSubjects = async () => {
                try {
                    const q = window.query(window.collection(window.db, "accounting_accounts"), window.orderBy("code"));
                    const snap = await window.getDocs(q);
                    const banks = [];
                    snap.forEach(d => {
                        const data = d.data();
                        const codeStr = String(data.code);
                        // ç¯©é¸æ¢ä»¶æ”¾å¯¬ï¼šåªè¦æ˜¯ 110 é–‹é ­çš„ (æ¶µè“‹ 1101, 1102... 1105)
                        if (data.code && (codeStr.startsWith('1101') || codeStr.startsWith('1102') || codeStr.startsWith('1103') || codeStr.startsWith('1104') || codeStr.startsWith('1105'))) {
                            banks.push({ code: data.code, name: data.name });
                        }
                    });
                    
                    if(banks.length === 0) {
                        // é è¨­å€¼ (é˜²å‘†)
                        banks.push({ code: '1102', name: 'éŠ€è¡Œå­˜æ¬¾ (é è¨­)' });
                    }
                    setBankOptions(banks);
                } catch(e) { console.error("Bank fetch error", e); }
            };

            const fetchCaregivers = async () => {
                try {
                    const q = window.query(window.collection(window.db, "employees"), window.where("role", "==", "caregiver"));
                    const snap = await window.getDocs(q);
                    const list = [];
                    snap.forEach(d => {
                        const data = d.data();
                        if (!data.resignDate) list.push({ id: d.id, name: data.name });
                    });
                    list.sort((a, b) => a.name.localeCompare(b.name, "zh-Hant"));
                    setCaregivers(list);
                } catch(e) { console.error(e); }
            };

            const fetchCaregiverMap = async () => {
                try {
                    const docSnap = await window.getDoc(window.doc(window.db, "system_settings", "client_caregiver_map"));
                    if(docSnap.exists()) setCaregiverMap(docSnap.data());
                } catch(e) {}
            };

            const fetchData = async () => {
                setLoading(true);
                try {
                    const q = window.query(
                        window.collection(window.db, "income_receivables"),
                        window.where("month", "==", currentMonth),
                        window.where("type", "==", activeTab === 'user_pay' ? 'user' : 'gov')
                    );
                    const snap = await window.getDocs(q);
                    const list = [];
                    snap.forEach(d => list.push({ id: d.id, ...d.data() }));
                    
                    list.sort((a, b) => {
                        const noA = a.caseNo || "";
                        const noB = b.caseNo || "";
                        return noA.localeCompare(noB, undefined, { numeric: true, sensitivity: 'base' });
                    });
                    
                    setReceivables(list);
                } catch (e) {}
                setLoading(false);
            };

            const handleBatchDelete = async () => {
                if (!isManager) return alert("â›” æ¬Šé™ä¸è¶³ï¼šåªæœ‰è€é—†å¸³è™Ÿå¯ä»¥åŸ·è¡Œæ•´ç­†åˆªé™¤ã€‚");
                if (receivables.length === 0) return alert("ç›®å‰æ²’æœ‰è³‡æ–™å¯åˆªé™¤");
                const pwd = prompt(`âš ï¸ è­¦å‘Šï¼šæ‚¨å³å°‡åˆªé™¤æœ¬æœˆ (${currentMonth}) æ‰€æœ‰è³‡æ–™ã€‚\n\nè«‹è¼¸å…¥å®‰å…¨å¯†ç¢¼ä»¥ç¢ºèªï¼š`);
                if (pwd !== SAFETY_PASSWORD) return alert("âŒ å¯†ç¢¼éŒ¯èª¤ï¼");

                setLoading(true);
                try {
                    const batch = window.writeBatch(window.db);
                    receivables.forEach(item => {
                        batch.delete(window.doc(window.db, "income_receivables", item.id));
                    });
                    await batch.commit();
                    alert("âœ… å·²å…¨éƒ¨åˆªé™¤ï¼");
                    fetchData();
                } catch (e) { alert("åˆªé™¤å¤±æ•—ï¼š" + e.message); }
                setLoading(false);
            };

            const handleSingleDelete = async (item) => {
                if (!confirm(`ç¢ºå®šè¦åˆªé™¤é€™ç­†ã€Œ${item.title || item.caseNo}ã€å—ï¼Ÿ`)) return;
                setLoading(true);
                try {
                    await window.deleteDoc(window.doc(window.db, "income_receivables", item.id));
                    alert("âœ… å·²åˆªé™¤");
                    fetchData();
                } catch(e) { alert("åˆªé™¤å¤±æ•—"); }
                setLoading(false);
            };

            const handlePrint = () => {
                let targetName = 'å…¨é«”';
                if (printCaregiver !== 'all') targetName = caregivers.find(c=>c.id===printCaregiver)?.name || 'æœªçŸ¥';

                const itemsToPrint = receivables
                    .filter(r => r.status !== 'paid') 
                    .filter(r => filterCollectionType === 'all' || r.collectionType === filterCollectionType)
                    .filter(r => printCaregiver === 'all' || r.caregiverId === printCaregiver);

                if (itemsToPrint.length === 0) return alert("æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è³‡æ–™å¯åˆ—å°ã€‚");

                const totalAmount = itemsToPrint.reduce((sum, item) => {
                    return (item.collectionType === 'caregiver_collect') ? sum + Number(item.amount || 0) : sum;
                }, 0);

                const printContent = `
                    <html>
                    <head>
                        <title>æ”¶æ¬¾æ¸…å–®</title>
                        <style>
                            body { font-family: "Microsoft JhengHei", sans-serif; padding: 20px; }
                            h1 { text-align: center; font-size: 24px; margin-bottom: 10px; }
                            .meta { text-align: center; margin-bottom: 20px; font-size: 14px; }
                            table { width: 100%; border-collapse: collapse; font-size: 14px; }
                            th, td { border: 1px solid black; padding: 8px 10px; text-align: center; }
                            th { background-color: #f0f0f0; }
                            .amount { text-align: right; font-family: monospace; font-size: 16px; font-weight: bold; }
                            .footer { margin-top: 30px; font-size: 12px; text-align: right; }
                            tfoot td { background-color: #f9fafb; font-size: 16px; }
                        </style>
                    </head>
                    <body>
                        <h1>å…‰ç¥é•·ç…§ - ${activeTab==='user_pay'?'æ°‘çœ¾è‡ªä»˜é¡':'æ”¿åºœæ ¸éŠ·'}æ”¶æ¬¾å–®</h1>
                        <div class="meta">
                            æœˆä»½ï¼š<b>${currentMonth}</b> &nbsp;&nbsp; 
                            å±…æœå“¡ï¼š<b>${targetName}</b> &nbsp;&nbsp;
                            é¡å‹ï¼š<b>${filterCollectionType === 'caregiver_collect' ? 'å±…æœå“¡æ”¶' : (filterCollectionType === 'transfer' ? 'è½‰å¸³' : 'å…¨éƒ¨')}</b>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th width="30%">æ¡ˆè™Ÿ</th>
                                    <th width="30%">å€‹æ¡ˆå§“å</th>
                                    <th width="40%">æ‡‰æ”¶é‡‘é¡</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${itemsToPrint.map(item => {
                                    const showAmount = item.collectionType === 'caregiver_collect';
                                    const amountDisplay = showAmount ? `$${new Intl.NumberFormat().format(item.amount)}` : '';
                                    return `
                                    <tr>
                                        <td>${item.caseNo}</td>
                                        <td>${item.clientName || ''}</td>
                                        <td class="amount">${amountDisplay}</td>
                                    </tr>
                                    `;
                                }).join('')}
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="2" style="text-align: right; font-weight: bold;">ç¸½è¨ˆæ‡‰æ”¶ï¼š</td>
                                    <td class="amount" style="border-top: 2px solid black;">$${new Intl.NumberFormat().format(totalAmount)}</td>
                                </tr>
                            </tfoot>
                        </table>
                        <div class="footer">åˆ—å°æ™‚é–“ï¼š${dayjs().format('YYYY-MM-DD HH:mm')}</div>
                        <script>window.print();<\/script>
                    </body>
                    </html>
                `;
                const win = window.open('', '_blank');
                win.document.write(printContent);
                win.document.close();
            };

            const processPaste = async () => {
                if(!pasteContent.trim()) return alert("è«‹å…ˆè²¼ä¸Šè³‡æ–™ï¼");
                setLoading(true);
                try {
                    const rows = pasteContent.trim().split('\n');
                    const batch = window.writeBatch(window.db);
                    let count = 0;
                    let debugInfo = "";

                    rows.forEach((line, index) => {
                        const cols = line.split('\t'); 
                        if (cols.length < 12) return;

                        const rawCaseNo = cols[0]; 
                        const rawName = cols[1];   
                        const rawAmount = cols[11]; 

                        const caseNo = rawCaseNo ? rawCaseNo.trim() : "";
                        const clientName = rawName ? maskName(rawName.trim()) : ""; 
                        const amountStr = rawAmount ? rawAmount.replace(/[^0-9.-]+/g, "") : "0";
                        const amount = Number(amountStr);

                        if (caseNo && !isNaN(amount) && !caseNo.includes("æ¡ˆè™Ÿ") && !caseNo.includes("Case")) {
                            if (!debugInfo) debugInfo = `ç¯„ä¾‹: ${caseNo} ${clientName} - $${amount}`;
                            
                            const assignedCaregiverId = caregiverMap[caseNo] || '';
                            const assignedCaregiverName = caregivers.find(c=>c.id===assignedCaregiverId)?.name || '';

                            const ref = window.doc(window.collection(window.db, "income_receivables"));
                            batch.set(ref, {
                                month: currentMonth, 
                                type: 'user', 
                                caseNo: caseNo, 
                                clientName: clientName, 
                                amount: amount,
                                status: 'pending', 
                                collectionType: 'caregiver_collect', 
                                caregiverId: assignedCaregiverId, 
                                caregiverName: assignedCaregiverName,
                                createdAt: new Date().toISOString()
                            });
                            count++;
                        }
                    });

                    if (count > 0) {
                        await batch.commit();
                        alert(`âœ… æˆåŠŸåŒ¯å…¥ ${count} ç­†ï¼\n${debugInfo}`);
                        setShowPasteModal(false); setPasteContent(''); fetchData();
                    } else {
                        alert("âš ï¸ æ‰¾ä¸åˆ°æœ‰æ•ˆè³‡æ–™ï¼è«‹ç¢ºèªè¤‡è£½ç¯„åœæ­£ç¢ºã€‚\nAæ¬„=æ¡ˆè™Ÿã€Bæ¬„=å§“åã€Læ¬„=é‡‘é¡");
                    }
                } catch(e) { alert("è™•ç†å¤±æ•—ï¼š" + e.message); }
                setLoading(false);
            };

            const updateCollectionType = async (item, newType) => {
                await window.updateDoc(window.doc(window.db, "income_receivables", item.id), {
                    collectionType: newType
                });
                fetchData();
            };

            const updateCaregiver = async (item, newCaregiverId) => {
                const newCaregiverName = caregivers.find(c=>c.id===newCaregiverId)?.name || '';
                await window.updateDoc(window.doc(window.db, "income_receivables", item.id), {
                    caregiverId: newCaregiverId, caregiverName: newCaregiverName
                });
                if (newCaregiverId) {
                    const mapRef = window.doc(window.db, "system_settings", "client_caregiver_map");
                    try { await window.updateDoc(mapRef, { [item.caseNo]: newCaregiverId }); } 
                    catch(e) { await window.setDoc(mapRef, { [item.caseNo]: newCaregiverId }, { merge: true }); }
                    setCaregiverMap(prev => ({ ...prev, [item.caseNo]: newCaregiverId }));
                }
                fetchData();
            };

            const handleCashCollect = async (item) => {
                if (!confirm(`ç¢ºå®šæ”¶åˆ°ã€${item.caseNo}ã€‘ç¾é‡‘ $${item.amount}ï¼Ÿ`)) return;
                setLoading(true);
                try {
                    const batch = window.writeBatch(window.db);
                    
                    const expenseRef = window.doc(window.collection(window.db, "accounting_expenses"));
                    batch.set(expenseRef, {
                        date: dayjs().format('YYYY-MM-DD'), 
                        type: 'income', 
                        item: `[æ”¶æ¬¾] æ¡ˆè™Ÿ ${item.caseNo} ${item.clientName}`,
                        amount: item.amount, 
                        category: 'æœå‹™æ”¶å…¥(ç¾é‡‘)', 
                        payer: 'user_payment',
                        note: `ç¶“æ‰‹äºº: ${currentUser.name}`, 
                        recorder: currentUser.name, 
                        status: 'locked', 
                        createdAt: new Date().toISOString()
                    });

                    batch.update(window.doc(window.db, "income_receivables", item.id), {
                        status: 'paid', 
                        paymentMethod: 'cash', 
                        paidAt: new Date().toISOString(), 
                        receiver: currentUser.name,
                        linkedExpenseId: expenseRef.id 
                    });

                    const pettyRef = window.doc(window.db, "system_settings", "petty_cash");
                    batch.set(pettyRef, { balance: window.increment(item.amount) }, { merge: true });

                    await batch.commit(); 
                    fetchData();
                } catch(e) { alert("å¤±æ•—: " + e.message); }
                setLoading(false);
            };

            const handleBankReport = async (item) => {
                if (!confirm(`ç¢ºèªæ¡ˆå®¶ã€${item.caseNo}ã€‘å·²åŒ¯æ¬¾ï¼Ÿ`)) return;
                await window.updateDoc(window.doc(window.db, "income_receivables", item.id), {
                    status: 'verifying', reportTime: new Date().toISOString(), reporter: currentUser.name
                });
                fetchData();
            };

            // è§¸ç™¼å…¥å¸³ç¢ºèªè¦–çª— (æ°‘çœ¾ & æ”¿åºœ é€šç”¨)
            const openConfirmModal = (item, type) => {
                if (!isManager) return alert("â›” æ¬Šé™ä¸è¶³ï¼šåªæœ‰è€é—†å¯ä»¥ç¢ºèªå…¥å¸³ã€‚");
                
                // è®€å–è¨˜æ†¶çš„éŠ€è¡Œ
                const storageKey = type === 'user' ? 'last_bank_user' : 'last_bank_gov';
                const lastBank = localStorage.getItem(storageKey) || (bankOptions[0]?.code || '');

                setConfirmAmount(item.amount); 
                setSelectedBankCode(lastBank);
                setConfirmModal({ show: true, type, data: item });
            };

            const executeConfirm = async () => {
                const { type, data } = confirmModal;
                const actAmount = Number(confirmAmount);
                const bankCode = selectedBankCode;
                const bankName = bankOptions.find(b=>b.code===bankCode)?.name || 'æœªçŸ¥éŠ€è¡Œ';

                if (!actAmount && actAmount !== 0) return alert("è«‹è¼¸å…¥æ­£ç¢ºé‡‘é¡");
                if (!bankCode) return alert("è«‹é¸æ“‡è½‰å…¥éŠ€è¡Œ");

                setLoading(true);
                try {
                    const batch = window.writeBatch(window.db);
                    const jRef = window.doc(window.collection(window.db, "accounting_journal"));
                    let entries = [];

                    if (type === 'gov') {
                        const diff = data.amount - actAmount;
                        entries = [{ type: 'debit', code: bankCode, name: bankName, amount: actAmount }];
                        if(diff > 0) entries.push({ type: 'debit', code: '4109', name: 'æ ¸éŠ·æŠ˜è®“', amount: diff });
                        entries.push({ type: 'credit', code: '4101', name: 'é•·ç…§æ”¶å…¥', amount: data.amount });
                    } else {
                        entries = [
                            { type: 'debit', code: bankCode, name: bankName, amount: actAmount },
                            { type: 'credit', code: '4201', name: 'è‡ªè²»æœå‹™æ”¶å…¥', amount: actAmount }
                        ];
                    }

                    batch.set(jRef, { 
                        date: dayjs().format('YYYY-MM-DD'), 
                        description: `${type==='gov'?'æ”¿åºœè£œåŠ©':'è‡ªè²»æ¬¾'}å…¥å¸³ (${data.caseNo || data.title})`, 
                        source: type==='gov' ? 'AR_GOV' : 'AR_USER_COLLECT', 
                        entries, 
                        totalAmount: data.amount, 
                        createdAt: new Date().toISOString() 
                    });

                    batch.update(window.doc(window.db, "income_receivables", data.id), { 
                        status: 'paid', 
                        paymentMethod: 'bank',
                        actualAmount: actAmount, 
                        paidAt: new Date().toISOString(),
                        confirmer: currentUser.name,
                        linkedJournalId: jRef.id  
                    });

                    await batch.commit();
                    
                    // è¨˜æ†¶é¸æ“‡
                    const storageKey = type === 'user' ? 'last_bank_user' : 'last_bank_gov';
                    localStorage.setItem(storageKey, bankCode);

                    alert("âœ… å…¥å¸³æˆåŠŸï¼");
                    setConfirmModal({ show: false, type: '', data: null });
                    fetchData();

                } catch(e) { alert("å…¥å¸³å¤±æ•—: " + e.message); }
                setLoading(false);
            };

            const handleUndo = async (item) => {
                if (item.paymentMethod === 'bank' && !isManager) return alert("â›” æ¬Šé™ä¸è¶³ï¼šåªæœ‰è€é—†å¯ä»¥æ’¤éŠ·åŒ¯æ¬¾ç´€éŒ„ã€‚");
                if (!confirm(`âš ï¸ ç¢ºå®šè¦æ’¤éŠ·ã€${item.caseNo || item.title}ã€‘çš„æ”¶æ¬¾ç´€éŒ„å—ï¼Ÿ`)) return;

                setLoading(true);
                try {
                    const batch = window.writeBatch(window.db);
                    const itemRef = window.doc(window.db, "income_receivables", item.id);
                    
                    batch.update(itemRef, {
                        status: 'pending',
                        paymentMethod: window.deleteField(),
                        actualAmount: window.deleteField(),
                        paidAt: window.deleteField(),
                        linkedExpenseId: window.deleteField(),
                        linkedJournalId: window.deleteField(),
                        confirmer: window.deleteField(),
                        receiver: window.deleteField()
                    });

                    if (item.linkedExpenseId) {
                        batch.update(window.doc(window.db, "system_settings", "petty_cash"), { balance: window.increment(-item.amount) });
                        batch.delete(window.doc(window.db, "accounting_expenses", item.linkedExpenseId));
                    }
                    if (item.linkedJournalId) {
                        batch.delete(window.doc(window.db, "accounting_journal", item.linkedJournalId));
                    }

                    await batch.commit(); alert("âœ… å·²æ’¤éŠ·æ”¶æ¬¾ï¼"); fetchData();
                } catch(e) { alert("æ’¤éŠ·å¤±æ•—: " + e.message); }
                setLoading(false);
            };

            const saveGovRecord = async () => {
                const b = Number(govForm.b) || 0, g = Number(govForm.g) || 0, s = Number(govForm.s) || 0, total = b + g + s;
                if (total <= 0) return alert("è«‹è‡³å°‘è¼¸å…¥ä¸€é …é‡‘é¡");
                setLoading(true);
                try {
                    await window.addDoc(window.collection(window.db, "income_receivables"), {
                        month: currentMonth, type: 'gov', title: `æ”¿åºœè£œåŠ©æ ¸éŠ· (${currentMonth})`, amount: total, breakdown: { b, g, s }, status: 'pending', createdAt: new Date().toISOString()
                    });
                    alert("âœ… æ–°å¢æˆåŠŸ"); setShowGovModal(false); setGovForm({ b: '', g: '', s: '' }); fetchData();
                } catch(e) { console.error(e); alert("æ–°å¢å¤±æ•—"); }
                setLoading(false);
            };

            const handleGovConfirm = async (item) => {
                const actual = prompt(`é è¨ˆ $${item.amount}ï¼Œå¯¦éš›å…¥å¸³é‡‘é¡ï¼Ÿ`, item.amount);
                if(!actual) return;
                const actAmount = Number(actual);
                const diff = item.amount - actAmount;
                const batch = window.writeBatch(window.db);
                batch.update(window.doc(window.db, "income_receivables", item.id), { status: 'paid', actualAmount: actAmount, paidAt: new Date().toISOString() });
                const entries = [{ type: 'debit', code: '1102', name: 'éŠ€è¡Œå­˜æ¬¾', amount: actAmount }];
                if(diff > 0) entries.push({ type: 'debit', code: '4109', name: 'æ ¸éŠ·æŠ˜è®“', amount: diff });
                entries.push({ type: 'credit', code: '4101', name: 'é•·ç…§æ”¶å…¥', amount: item.amount });
                const jRef = window.doc(window.collection(window.db, "accounting_journal"));
                batch.set(jRef, { date: dayjs().format('YYYY-MM-DD'), description: `æ”¿åºœè£œåŠ©å…¥å¸³ ${item.title}`, source: 'AR_GOV', entries, totalAmount: item.amount, createdAt: new Date().toISOString() });
                await batch.commit(); alert("âœ… å…¥å¸³æˆåŠŸ"); fetchData();
            };

            const filteredReceivables = useMemo(() => {
                return receivables.filter(r => {
                    const matchCollection = filterCollectionType === 'all' || r.collectionType === filterCollectionType;
                    const matchCaregiver = printCaregiver === 'all' || r.caregiverId === printCaregiver;
                    return matchCollection && matchCaregiver;
                });
            }, [receivables, filterCollectionType, printCaregiver]);

            return (
                <div className="flex h-screen overflow-hidden">
                    <div className="w-64 bg-slate-900 text-white flex flex-col p-4 shadow-xl shrink-0 no-print">
                        <div className="text-2xl font-black tracking-widest mb-10 text-center">KUANG-YOU<div className="text-xs font-normal opacity-50 tracking-normal">INCOME</div></div>
                        <nav className="flex-1 space-y-2">
                            <button onClick={()=>setActiveTab('user_pay')} className={`w-full text-left p-3 rounded-lg transition ${activeTab==='user_pay'?'bg-blue-600 text-white':'hover:bg-slate-800 text-slate-400'}`}>ğŸ‘¥ æ°‘çœ¾æ”¶æ¬¾</button>
                            <button onClick={()=>setActiveTab('gov_pay')} className={`w-full text-left p-3 rounded-lg transition ${activeTab==='gov_pay'?'bg-emerald-600 text-white':'hover:bg-slate-800 text-slate-400'}`}>ğŸ›ï¸ æ”¿åºœæ ¸éŠ·</button>
                        </nav>
                        <div className="mt-auto border-t border-slate-700 pt-4">
                            <div className="text-xs text-slate-400 mb-2">ç™»å…¥èº«ä»½ï¼š</div>
                            <div className={`font-bold ${isManager ? 'text-yellow-400' : 'text-slate-300'}`}>
                                {isManager ? 'ğŸ‘‘ è€é—† (Manager)' : 'ğŸ‘¤ è¡Œæ”¿äººå“¡'}
                            </div>
                            <div className="text-[10px] text-slate-500 mt-1 truncate">{userEmail}</div>
                        </div>
                        <a href="index.html" className="text-xs text-slate-500 text-center mt-4 hover:text-white pb-2">â† è¿”å›å…¥å£</a>
                    </div>

                    <div className="flex-1 bg-slate-100 overflow-auto p-8 relative">
                        <div className="flex justify-between items-center mb-6 no-print">
                            <div className="flex items-center gap-4">
                                <h2 className="text-2xl font-bold text-slate-800">{activeTab==='user_pay'?'æ°‘çœ¾è‡ªè² é¡':'æ”¿åºœè£œåŠ©æ¬¾'}</h2>
                                <input type="month" value={currentMonth} onChange={e=>setCurrentMonth(e.target.value)} className="border-2 border-slate-300 rounded-lg p-1 text-lg font-bold" />
                            </div>
                            <div className="flex gap-2">
                                {activeTab === 'user_pay' && (
                                    <>
                                        {isManager && (
                                            <button onClick={handleBatchDelete} className="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-bold shadow flex items-center gap-2">ğŸ—‘ï¸ æ¸…é™¤æœ¬æœˆ</button>
                                        )}
                                        <button onClick={()=>setShowPasteModal(true)} className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-bold shadow flex items-center gap-2">ğŸ“‹ è²¼ä¸Š Excel è³‡æ–™</button>
                                        <button onClick={handlePrint} className="bg-slate-600 hover:bg-slate-700 text-white px-4 py-2 rounded-lg font-bold shadow flex items-center gap-2">ğŸ–¨ï¸ åˆ—å°æ¸…å–®</button>
                                    </>
                                )}
                                {activeTab === 'gov_pay' && (
                                    <>
                                        {isManager && <button onClick={handleBatchDelete} className="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-bold shadow">ğŸ—‘ï¸ æ¸…é™¤æœ¬æœˆ</button>}
                                        <button onClick={()=>setShowGovModal(true)} className="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg font-bold shadow">ï¼‹ æ–°å¢æ ¸éŠ·ç´€éŒ„</button>
                                    </>
                                )}
                            </div>
                        </div>

                        {/* User List */}
                        {activeTab === 'user_pay' && (
                            <div className="bg-white rounded-xl shadow-sm overflow-hidden no-print">
                                <div className="p-4 bg-slate-50 border-b flex justify-between items-center gap-4">
                                    <span className="font-bold text-slate-500">æœ¬æœˆå¾…æ”¶åˆ—è¡¨ (å…± {filteredReceivables.length} ç­†)</span>
                                    <div className="flex gap-2">
                                        <select className="border p-1 rounded text-sm bg-white" value={filterCollectionType} onChange={e=>setFilterCollectionType(e.target.value)}>
                                            <option value="all">ğŸ’³ å…¨éƒ¨æ–¹å¼</option>
                                            <option value="caregiver_collect">ğŸ‘¤ å±…æœå“¡æ”¶</option>
                                            <option value="transfer">ğŸ¦ è½‰å¸³</option>
                                            <option value="none">ğŸš« ç„¡</option>
                                        </select>
                                        <select className="border p-1 rounded text-sm bg-white" value={printCaregiver} onChange={e=>setPrintCaregiver(e.target.value)}>
                                            <option value="all">ğŸ‘¥ å…¨éƒ¨å±…æœå“¡</option>
                                            {caregivers.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                                        </select>
                                    </div>
                                </div>
                                <table className="w-full text-left">
                                    <thead className="bg-slate-100 text-slate-600 font-bold border-b">
                                        <tr>
                                            <th className="p-3">æ¡ˆè™Ÿ / å§“å</th>
                                            <th className="p-3 w-32">æ”¶æ¬¾æ–¹å¼</th>
                                            <th className="p-3">è² è²¬å±…æœå“¡ (æ´¾å–®)</th>
                                            <th className="p-3 text-right">é‡‘é¡</th>
                                            <th className="p-3 text-center">ç‹€æ…‹</th>
                                            <th className="p-3 text-right">æ“ä½œ</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-100">
                                        {filteredReceivables.map(item => (
                                            <tr key={item.id} className={item.status==='paid' ? 'bg-slate-50 opacity-60' : (item.status==='verifying'?'bg-yellow-50':'hover:bg-blue-50')}>
                                                <td className="p-3">
                                                    <div className="font-bold text-slate-700">{item.caseNo}</div>
                                                    <div className="text-xs text-slate-500">{item.clientName}</div>
                                                </td>
                                                <td className="p-3">
                                                    {item.status === 'pending' ? (
                                                        <select className="border rounded p-1 text-sm w-full bg-white" value={item.collectionType || 'caregiver_collect'} onChange={(e)=>updateCollectionType(item, e.target.value)}>
                                                            <option value="caregiver_collect">å±…æœå“¡æ”¶</option>
                                                            <option value="transfer">è½‰å¸³</option>
                                                            <option value="none">ç„¡</option>
                                                        </select>
                                                    ) : (
                                                        <span className="text-sm font-bold text-slate-600">
                                                            {item.collectionType==='transfer'?'è½‰å¸³':(item.collectionType==='none'?'ç„¡':'å±…æœå“¡æ”¶')}
                                                        </span>
                                                    )}
                                                </td>
                                                <td className="p-3">
                                                    {item.status === 'pending' ? (
                                                        <select className={`border rounded p-1 text-sm w-full bg-white ${!item.caregiverId ? 'border-red-400' : 'border-slate-300'}`} value={item.caregiverId||''} onChange={(e)=>updateCaregiver(item, e.target.value)}>
                                                            <option value="">-- è«‹æŒ‡æ´¾ --</option>
                                                            {caregivers.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                                                        </select>
                                                    ) : (<span className="text-sm">{item.caregiverName}</span>)}
                                                </td>
                                                <td className="p-3 text-right font-mono font-bold">${item.amount}</td>
                                                <td className="p-3 text-center">
                                                    {item.status === 'pending' && (
                                                        item.amount === 0 ? 
                                                        <span className="bg-gray-100 text-gray-500 border border-gray-200 px-2 py-1 rounded text-xs font-bold whitespace-nowrap">ç„¡é ˆç¹³ç´</span> :
                                                        <span className="text-red-500 font-bold text-xs">æœªç¹³</span>
                                                    )}
                                                    {item.status === 'verifying' && <span className="bg-yellow-200 text-yellow-800 px-2 py-1 rounded text-xs font-bold animate-pulse">å¾…æ ¸å¸³</span>}
                                                    {item.status === 'paid' && <span className="bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-bold">å·²å…¥å¸³</span>}
                                                </td>
                                                <td className="p-3 text-right flex justify-end gap-2">
                                                    {item.status === 'pending' && (
                                                        <>
                                                            <button onClick={()=>handleCashCollect(item)} className="bg-green-500 text-white px-2 py-1 rounded text-xs hover:bg-green-600">æ”¶ç¾é‡‘</button>
                                                            <button onClick={()=>handleBankReport(item)} className="bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600">å›å ±åŒ¯æ¬¾</button>
                                                        </>
                                                    )}
                                                    {item.status === 'verifying' && (
                                                        isManager ? (
                                                            <button onClick={()=>openConfirmModal(item, 'user')} className="bg-slate-800 text-white px-3 py-1 rounded text-xs hover:bg-black shadow-lg transform scale-105">è€é—†ç¢ºèªå…¥å¸³</button>
                                                        ) : (
                                                            <span className="text-xs text-slate-400 italic">â³ ç­‰å¾…è€é—†æ ¸å¸³...</span>
                                                        )
                                                    )}
                                                    {item.status === 'paid' && <button onClick={()=>handleUndo(item)} className="bg-gray-200 hover:bg-red-100 text-gray-500 hover:text-red-600 px-2 py-1 rounded text-xs font-bold shadow-sm">â†©ï¸ æ’¤éŠ·</button>}
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )}

                        {/* Gov List */}
                        {activeTab === 'gov_pay' && (
                            <div className="bg-white rounded-xl shadow-sm overflow-hidden no-print">
                                <table className="w-full text-left">
                                    <thead className="bg-slate-100 font-bold text-slate-600"><tr><th className="p-4">é …ç›®</th><th className="p-4 text-right">ç”³å ±ç¸½é¡</th><th className="p-4 text-right">å¯¦å…¥é‡‘é¡</th><th className="p-4 text-right">æ“ä½œ</th></tr></thead>
                                    <tbody className="divide-y">
                                        {receivables.map(item => (
                                            <tr key={item.id} className="hover:bg-slate-50">
                                                <td className="p-4"><div className="font-bold">{item.title}</div>{item.breakdown && <div className="text-xs text-slate-400 mt-1 font-mono">B: ${item.breakdown.b} | G: ${item.breakdown.g} | S: ${item.breakdown.s}</div>}</td>
                                                <td className="p-4 text-right font-mono">${new Intl.NumberFormat().format(item.amount)}</td>
                                                <td className="p-4 text-right font-mono text-green-600">{item.actualAmount ? `$${new Intl.NumberFormat().format(item.actualAmount)}` : '-'}</td>
                                                <td className="p-4 text-right">
                                                    {item.status === 'pending' ? (
                                                        <div className="flex justify-end gap-2">
                                                            <button onClick={()=>openConfirmModal(item, 'gov')} className="bg-slate-800 text-white px-4 py-2 rounded text-sm font-bold">ç¢ºèªå…¥å¸³</button>
                                                            <button onClick={()=>handleSingleDelete(item)} className="bg-red-100 text-red-500 hover:bg-red-200 px-3 py-2 rounded" title="åˆªé™¤æ­¤ç­†">ğŸ—‘ï¸</button>
                                                        </div>
                                                    ) : (
                                                        <div className="flex items-center justify-end gap-2">
                                                            <span className="text-green-600 font-bold text-xs">å·²çµæ¡ˆ</span>
                                                            <button onClick={()=>handleUndo(item)} className="bg-gray-100 hover:bg-red-100 text-gray-400 hover:text-red-500 px-2 py-1 rounded text-xs">â†©ï¸</button>
                                                        </div>
                                                    )}
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )}

                        {/* Modal: Confirm Payment */}
                        {confirmModal.show && (
                            <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
                                <div className="bg-white w-full max-w-sm rounded-2xl shadow-2xl p-6 space-y-4 animate-slide-up">
                                    <h3 className="text-lg font-bold text-slate-800">
                                        {confirmModal.type === 'gov' ? 'ğŸ›ï¸ æ”¿åºœæ¬¾å…¥å¸³ç¢ºèª' : 'ğŸ‘¤ æ°‘çœ¾æ¬¾å…¥å¸³ç¢ºèª'}
                                    </h3>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500 block mb-1">å¯¦éš›å…¥å¸³é‡‘é¡</label>
                                        <input type="number" className="w-full border-2 border-blue-500 rounded-lg p-2 text-xl font-bold font-mono" value={confirmAmount} onChange={e=>setConfirmAmount(e.target.value)} />
                                        {confirmModal.type === 'gov' && (
                                            <div className="text-xs text-red-500 mt-1">
                                                è‹¥å°‘æ–¼ç”³å ±é¡ ${confirmModal.data.amount}ï¼Œç³»çµ±å°‡è‡ªå‹•ç”¢ç”ŸæŠ˜è®“å‚³ç¥¨ã€‚
                                            </div>
                                        )}
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500 block mb-1">å­˜å…¥éŠ€è¡Œ</label>
                                        <select className="w-full border rounded-lg p-2 text-sm bg-slate-50" value={selectedBankCode} onChange={e=>setSelectedBankCode(e.target.value)}>
                                            <option value="" disabled>-- è«‹é¸æ“‡å­˜å…¥å¸³æˆ¶ --</option>
                                            {bankOptions.map(b => (
                                                <option key={b.code} value={b.code}>{b.code} {b.name}</option>
                                            ))}
                                        </select>
                                    </div>
                                    <div className="flex gap-2 pt-2">
                                        <button onClick={()=>setConfirmModal({show:false, type:'', data:null})} className="flex-1 bg-gray-200 text-gray-600 font-bold py-2 rounded-lg">å–æ¶ˆ</button>
                                        <button onClick={executeConfirm} className="flex-1 bg-slate-800 text-white font-bold py-2 rounded-lg hover:bg-black">ç¢ºèªå…¥å¸³</button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {showPasteModal && (
                            <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm no-print">
                                <div className="bg-white w-full max-w-2xl rounded-2xl shadow-2xl overflow-hidden animate-slide-up flex flex-col h-[80vh]">
                                    <div className="bg-blue-600 p-4 text-white font-bold flex justify-between"><span>ğŸ“‹ åŒ¯å…¥å¸³å–® (Excel ç›´æ¥è²¼ä¸Š)</span><button onClick={()=>setShowPasteModal(false)}>âœ•</button></div>
                                    <div className="p-6 flex-1 flex flex-col space-y-4">
                                        <div className="bg-blue-50 p-3 rounded text-sm text-blue-800">
                                            <p className="font-bold mb-1">ä½¿ç”¨èªªæ˜ï¼š</p>
                                            <ol className="list-decimal pl-5 space-y-1">
                                                <li>æ‰“é–‹ Excelï¼Œè¤‡è£½åŒ…å« <b>æ¡ˆè™Ÿ(A)ã€å§“å(B)...é‡‘é¡(L)</b> çš„è³‡æ–™ã€‚</li>
                                                <li>é»æ“Šä¸‹æ–¹æ¡†æ¡†ï¼ŒæŒ‰ <b>è²¼ä¸Š (Ctrl+V)</b>ã€‚</li>
                                                <li>æŒ‰ä¸‹ã€Œé–‹å§‹åˆ†æã€æŒ‰éˆ•ã€‚</li>
                                            </ol>
                                        </div>
                                        <textarea className="w-full flex-1 border-2 border-slate-300 rounded-lg p-4 font-mono text-xs focus:border-blue-500 outline-none resize-none" placeholder="è«‹åœ¨é€™è£¡è²¼ä¸Š Excel è³‡æ–™..." value={pasteContent} onChange={e=>setPasteContent(e.target.value)}></textarea>
                                        <button onClick={processPaste} className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow-lg">ğŸš€ é–‹å§‹åˆ†æä¸¦åŒ¯å…¥</button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {showGovModal && (
                            <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm no-print">
                                <div className="bg-white w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden animate-slide-up">
                                    <div className="bg-slate-800 p-4 text-white font-bold flex justify-between"><span>æ–°å¢æ”¿åºœæ ¸éŠ·</span><button onClick={()=>setShowGovModal(false)}>âœ•</button></div>
                                    <div className="p-6 space-y-4">
                                        <div><label className="text-xs font-bold text-slate-500">Bç¢¼ (ç…§é¡§å°ˆæ¥­)</label><input type="number" className="w-full border rounded p-2" value={govForm.b} onChange={e=>setGovForm({...govForm, b: e.target.value})} placeholder="$" /></div>
                                        <div><label className="text-xs font-bold text-slate-500">Gç¢¼ (å–˜æ¯æœå‹™)</label><input type="number" className="w-full border rounded p-2" value={govForm.g} onChange={e=>setGovForm({...govForm, g: e.target.value})} placeholder="$" /></div>
                                        <div><label className="text-xs font-bold text-slate-500">Sç¢¼ (å…¶ä»–/åŠ çµ¦)</label><input type="number" className="w-full border rounded p-2" value={govForm.s} onChange={e=>setGovForm({...govForm, s: e.target.value})} placeholder="$" /></div>
                                        <div className="border-t pt-2 text-right"><span className="text-sm text-slate-500 mr-2">ç¸½è¨ˆ:</span><span className="text-xl font-bold text-slate-800">${Number(govForm.b)+Number(govForm.g)+Number(govForm.s)}</span></div>
                                        <button onClick={saveGovRecord} className="w-full bg-emerald-600 text-white font-bold py-3 rounded-lg">ç¢ºèªæ–°å¢</button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<IncomeApp />);
    </script>
</body>

</html>
